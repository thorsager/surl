name: Cleanup PR Images

on:
  pull_request:
    types: [closed]

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
      pull-requests: write
    
    steps:
      - name: Delete PR Docker image
        id: delete-image
        run: |
          PACKAGE_NAME="surl"
          PR_TAG="pr-${{ github.event.pull_request.number }}"
          OWNER="${{ github.repository_owner }}"
          
          echo "Looking for image tagged with: $PR_TAG"
          
          # Query package versions from user account
          VERSION_ID=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/users/$OWNER/packages/container/$PACKAGE_NAME/versions" \
            --jq ".[] | select(.metadata.container.tags[]? == \"$PR_TAG\") | .id" \
            2>/dev/null || echo "")
          
          if [ -z "$VERSION_ID" ]; then
            echo "No image found with tag $PR_TAG - may have been deleted already or never created"
            echo "deleted=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Found version ID: $VERSION_ID"
          echo "Deleting image..."
          
          # Delete the package version
          gh api \
            --method DELETE \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/users/$OWNER/packages/container/$PACKAGE_NAME/versions/$VERSION_ID"
          
          if [ $? -eq 0 ]; then
            echo "Successfully deleted image tagged $PR_TAG"
            echo "deleted=true" >> $GITHUB_OUTPUT
            echo "pr_tag=$PR_TAG" >> $GITHUB_OUTPUT
          else
            echo "Failed to delete image"
            echo "deleted=false" >> $GITHUB_OUTPUT
            exit 0
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Comment on PR
        if: steps.delete-image.outputs.deleted == 'true'
        run: |
          gh pr comment ${{ github.event.pull_request.number }} \
            --repo ${{ github.repository }} \
            --body "üóëÔ∏è **Docker image cleanup completed**

          The Docker image tagged \`${{ steps.delete-image.outputs.pr_tag }}\` has been automatically deleted from GitHub Container Registry.
          
          - **Package:** \`ghcr.io/${{ github.repository }}\`
          - **Tag:** \`${{ steps.delete-image.outputs.pr_tag }}\`
          - **Platforms removed:** linux/amd64, linux/arm64/v8, linux/arm/v6, linux/arm/v7"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
