# This workflow will build a golang project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-go

name: Go

on:
  push:
    branches: 
      - '**'
    tags-ignore:
      - '**'
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      pull-requests: write
    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ">=1.22.0"

    - name: Build
      run: make build

    - name: Test
      run: make test

    # Scan Go code and dependencies for vulnerabilities with Trivy
    # https://github.com/aquasecurity/trivy-action
    - name: Run Trivy vulnerability scanner (filesystem)
      uses: aquasecurity/trivy-action@0.28.0
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'table'
        output: 'trivy-results.txt'
        ignore-unfixed: false
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'
        scanners: 'vuln,secret,config'
        trivy-config: 'trivy.yaml'

    - name: Check Trivy scan results
      id: trivy-check
      run: |
        if [ -f trivy-results.txt ]; then
          # Check if Trivy found any vulnerabilities
          if grep -q "Total: [1-9]" trivy-results.txt || grep -q "Total: [0-9][0-9]" trivy-results.txt; then
            echo "has_issues=true" >> $GITHUB_OUTPUT
            echo "Vulnerabilities found"
          else
            echo "has_issues=false" >> $GITHUB_OUTPUT
            echo "No vulnerabilities found"
          fi
          # Save the full output for PR comment
          {
            echo 'scan_output<<EOF'
            cat trivy-results.txt
            echo EOF
          } >> $GITHUB_OUTPUT
        else
          echo "has_issues=false" >> $GITHUB_OUTPUT
          echo "Trivy results file not found"
        fi

    - name: Run Trivy vulnerability scanner (SARIF)
      if: steps.trivy-check.outputs.has_issues == 'true'
      uses: aquasecurity/trivy-action@0.28.0
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH'
        scanners: 'vuln,secret,config'
        trivy-config: 'trivy.yaml'

    - name: Upload Trivy results to GitHub Security tab
      if: steps.trivy-check.outputs.has_issues == 'true'
      uses: github/codeql-action/upload-sarif@v4
      with:
        sarif_file: 'trivy-results.sarif'

    - name: Post success comment to PR
      if: github.event_name == 'pull_request' && steps.trivy-check.outputs.has_issues == 'false'
      uses: actions/github-script@v7
      with:
        script: |
          const body = `## ‚úÖ Trivy scan completed - no security issues found

          **Scan Type:** Filesystem (Go modules, secrets, misconfigurations)
          **Severity Filter:** CRITICAL, HIGH
          **Scanners:** Vulnerabilities, Secrets, Misconfigurations
          
          Your code is secure! üéâ`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });

    - name: Post issues found comment to PR
      if: github.event_name == 'pull_request' && steps.trivy-check.outputs.has_issues == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const scanOutput = `${{ steps.trivy-check.outputs.scan_output }}`;
          const body = `## üö® Trivy Security Scan - Issues Found

          **Security vulnerabilities, secrets, or misconfigurations detected!**
          
          **Severity Filter:** CRITICAL, HIGH
          **Scanners:** Vulnerabilities, Secrets, Misconfigurations

          ### Scan Results

          \`\`\`
          ${scanOutput}
          \`\`\`

          ‚ö†Ô∏è **This PR cannot be merged until these issues are resolved.**
          
          For more details, check the [Security tab](https://github.com/${{ github.repository }}/security/code-scanning).`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });

    - name: Fail job if security issues found
      if: steps.trivy-check.outputs.has_issues == 'true'
      run: |
        echo "Security issues found - failing job to block PR merge"
        exit 1
